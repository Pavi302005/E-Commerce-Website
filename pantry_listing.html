<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshCart üõí - Produce</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 20px; background-color: #f8f8f8;  max-width: 1280px; 
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;  
        }
        .header { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cart-summary { font-size: 1.2em; font-weight: bold; color: #007bff; border: 2px solid #007bff; padding: 8px 12px; border-radius: 8px; }
        .search-bar { margin-top: 15px; display: flex; gap: 10px; }
        .search-bar input { flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }
        .search-bar button { padding: 8px 15px; border-radius: 6px; border: none; background-color: #007bff; color: white; cursor: pointer; }
        .search-bar button:hover { background-color: #0056b3; }
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 130px;
            padding: 20px 0;
        }
        .product-card {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .product-card img { max-width: 100%; height: auto; max-height: 150px; object-fit: contain; border-radius: 8px; margin-bottom: 10px; }
        .organic-tag { background-color: #28a745; color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; font-weight: bold; }
        .add-to-cart-btn { background-color: #ffc107; color: black; border: none; padding: 10px 18px; margin-top: 15px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: background-color 0.2s; }
        .add-to-cart-btn:hover { background-color: #ffaa00; }
        h1 { color: #007bff; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Household & Cleaning (Pantry Demo) üßºüßΩ</h1>
        <div class="cart-summary" id="cart-summary">Cart: 0 items ($0.00)</div>
    </div>

    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search for fruits or vegetables...">
        <button id="search-btn">Search</button>
    </div><br><br>

    <a href="index.html" style="text-decoration: none; color: #007bff; font-weight: bold;">‚Üê Back to Aisles</a>
    <hr style="margin: 15px 0;">

    <div id="products-container" class="product-list">
        <div>Loading organic produce...</div>
    </div>

<script>
const API_BASE_URL = 'http://localhost:5000/api/items'; 
const container = document.getElementById('products-container');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// üõí Update cart display
function updateCartDisplay() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    let cartHTML = `üõí Cart: ${totalItems} items ($${totalPrice.toFixed(2)})`;

    // Show Finish Order button ONLY if cart has items
    if (totalItems > 0) {
        cartHTML += `
            <button id="finish-order"
                style="background:#28a745;color:white;border:none;
                padding:6px 10px;border-radius:6px;margin-left:8px;cursor:pointer;">
                Finish Order ‚úÖ
            </button>`;
    }

    document.getElementById('cart-summary').innerHTML = cartHTML;
    localStorage.setItem('cart', JSON.stringify(cart));

    const finishBtn = document.getElementById('finish-order');
    if (finishBtn) {
        finishBtn.addEventListener('click', showOrderSummary);
    }
}


// üõí Add to cart logic
function addToCart(productId, name, price) {
    const existingItem = cart.find(item => item.product_id === productId);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({ product_id: productId, name, price, quantity: 1 });
    }
    updateCartDisplay();
}

// üì¶ Order Summary Popup
function showOrderSummary() {
    const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    if (cart.length === 0) {
        alert("üõí Your cart is empty!");
        return;
    }

    let summaryHtml = `
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;
                     background:rgba(0,0,0,0.6);display:flex;justify-content:center;
                     align-items:center;z-index:1000;">
            <div style="background:white;padding:20px;border-radius:12px;
                         width:90%;max-width:500px;text-align:center;">
                <h2>üßæ Order Summary</h2>
                <table style="width:100%;margin-top:10px;border-collapse:collapse;">
                    <tr><th style="text-align:left;">Item</th><th>Qty</th><th>Price</th></tr>`;

    cart.forEach(item => {
        summaryHtml += `<tr>
            <td style="text-align:left;">${item.name}</td>
            <td>${item.quantity}</td>
            <td>$${(item.price * item.quantity).toFixed(2)}</td>
        </tr>`;
    });

    summaryHtml += `
                </table>
                <hr>
                <h3>Total Amount: $${totalAmount.toFixed(2)}</h3>
                <button id="confirm-order" 
                    style="background:#007bff;color:white;border:none;padding:10px 20px;border-radius:8px;margin-top:10px;cursor:pointer;">
                    Confirm Order ‚úÖ
                </button>
                <button id="close-summary" 
                    style="background:#dc3545;color:white;border:none;padding:10px 20px;border-radius:8px;margin-top:10px;cursor:pointer;">
                    Close ‚ùå
                </button>
            </div>
        </div>`;

    const overlay = document.createElement('div');
    overlay.innerHTML = summaryHtml;
    document.body.appendChild(overlay);

    // ‚úÖ Confirm Order Logic
    document.getElementById('confirm-order').addEventListener('click', () => {
        
        // ‚û°Ô∏è START: LOGIC TO SAVE ORDER HISTORY TO 'myList'
        const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const newOrder = {
            orderDate: new Date().toLocaleDateString(),
            items: cart.map(item => ({ name: item.name, price: item.price * item.quantity, quantity: item.quantity })),
            total: totalPrice
        };

        let orders = JSON.parse(localStorage.getItem('myList')) || [];
        orders.push(newOrder);
        localStorage.setItem('myList', JSON.stringify(orders));
        // ‚¨ÖÔ∏è END: LOGIC TO SAVE ORDER HISTORY
        overlay.remove(); // close order summary
    showPaymentOptions();
    });

    // ‚ùå Close Button
    document.getElementById('close-summary').addEventListener('click', () => {
        overlay.remove();
    });
}

// üß∫ Render products (only fruits & vegetables)
function renderProducts(products) {
    container.innerHTML = ''; 
    if (!products || products.length === 0) {
        container.innerHTML = '<h2 style="color: #666; text-align: center;">No fruits or vegetables found.</h2>';
        return;
    }

    const filtered = products.filter(
             p => p.category?.includes('Household')
    );

    if (filtered.length === 0) {
        container.innerHTML = '<h2 style="color: #666; text-align: center;">No fruits or vegetables found.</h2>';
        return;
    }

    filtered.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <img src="${product.image_url}" alt="${product.name}" 
                onerror="this.onerror=null;this.src='https://placehold.co/200x150/007bff/FFFFFF?text=No+Image';">
            <h3>${product.name} ${product.is_organic ? '<span class="organic-tag">ORGANIC</span>' : ''}</h3>
            <p>Price: <strong>$${product.price.toFixed(2)} ${product.unit_of_sale || ''}</strong></p>
            <p style="font-size: 0.8em; color: #888;">Category: ${product.category}</p>
            <button class="add-to-cart-btn" 
                onclick="addToCart('${product.product_id}', '${product.name.replace(/'/g,"\\'")}', ${product.price})">
                Add to Cart üõí
            </button>
        `;
        container.appendChild(card);
    });
}
function showPaymentOptions() {
    const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    const paymentHTML = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;
                background:rgba(0,0,0,0.6);display:flex;
                justify-content:center;align-items:center;z-index:1000;">
        <div style="background:white;padding:20px;border-radius:12px;
                    width:90%;max-width:400px;text-align:center;">
            <h2>üí≥ Payment Options</h2>
            <p>Total Amount: <strong>$${totalAmount.toFixed(2)}</strong></p>

            <div style="text-align:left;margin-top:15px;">
                <label><input type="radio" name="payment" checked> UPI</label><br><br>
                <label><input type="radio" name="payment"> Credit / Debit Card</label><br><br>
                <label><input type="radio" name="payment"> Cash on Delivery</label>
            </div>

            <button id="pay-now"
                style="background:#28a745;color:white;border:none;
                padding:10px 20px;border-radius:8px;margin-top:15px;cursor:pointer;">
                Pay Now ‚úÖ
            </button>

            <button id="cancel-payment"
                style="background:#dc3545;color:white;border:none;
                padding:10px 20px;border-radius:8px;margin-top:10px;cursor:pointer;">
                Cancel ‚ùå
            </button>
        </div>
    </div>`;

    const paymentOverlay = document.createElement('div');
    paymentOverlay.innerHTML = paymentHTML;
    document.body.appendChild(paymentOverlay);

    // Pay Now
    document.getElementById('pay-now').addEventListener('click', () => {
        saveOrderAndClearCart();
        paymentOverlay.remove();
    });

    // Cancel
    document.getElementById('cancel-payment').addEventListener('click', () => {
        paymentOverlay.remove();
    });
}
function saveOrderAndClearCart() {
    const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    const newOrder = {
        id: "FC-" + Date.now(),                     // ‚úÖ unique order id
        date: new Date().toLocaleString(),
        status: "Order Placed",
        payment: "Online / COD",
        items: cart.map(item => ({
            name: item.name,
            quantity: item.quantity,
            price: item.price
        })),
        total: totalPrice
    };

    // ‚úÖ SAVE ORDER HISTORY
    let orders = JSON.parse(localStorage.getItem('myList')) || [];
    orders.push(newOrder);
    localStorage.setItem('myList', JSON.stringify(orders));

    // ‚úÖ SAVE LATEST ORDER (VERY IMPORTANT)
    localStorage.setItem('currentOrder', JSON.stringify(newOrder));

    alert("üéâ Payment Successful!\nOrder placed successfully.");

    // ‚úÖ CLEAR CART
    cart = [];
    localStorage.removeItem('cart');
    updateCartDisplay();

    // ‚úÖ GO BACK TO HOME PAGE
    window.location.href = "index.html";
}


// üåê Fetch products
function fetchProducts(searchTerm = '') {
    let url = `${API_BASE_URL}`;
    if (searchTerm) url += `?q=${encodeURIComponent(searchTerm)}`;
    container.innerHTML = '<div>Loading fruits & vegetables...</div>';

    fetch(url)
        .then(res => res.json())
        .then(data => renderProducts(Array.isArray(data) ? data : data.data))
        .catch(err => {
            console.error('Fetch error:', err);
            container.innerHTML = `<div style="color: red; text-align: center;">Error fetching data. Is the server running?</div>`;
        });
}
searchBtn.addEventListener('click', () => fetchProducts(searchInput.value.trim()));
searchInput.addEventListener('keypress', (e) => e.key === "Enter" && searchBtn.click());
document.addEventListener('DOMContentLoaded', () => {
    fetchProducts();
    updateCartDisplay();
});
</script>
</body>
</html>